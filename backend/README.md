# Backend –¥–ª—è Telegram Mini App "–ì–µ–æ–º–µ—Ç—Ä–∏—è"

Backend-—Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å—Ç—É–¥–∏–∏ —Ç–∞–Ω—Ü–µ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Telegram Mini App, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram –∏ —Å–∏—Å—Ç–µ–º–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
npm install
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ `.env.example` –≤ `.env` –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:

```bash
cp .env.example .env
```

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
- `BOT_TOKEN` - —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ Telegram –±–æ—Ç–∞ (–ø–æ–ª—É—á–∏—Ç—å —É @BotFather)
- `JWT_SECRET` - —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è JWT —Ç–æ–∫–µ–Ω–æ–≤
- `ADMIN_TELEGRAM_IDS` - ID –∞–¥–º–∏–Ω–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é

### 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
npx prisma migrate dev --name init

# –ó–∞–ø–æ–ª–Ω–∏—Ç—å –±–∞–∑—É –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
npm run seed
```

### 4. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

```bash
# Development —Ä–µ–∂–∏–º
npm run dev

# Production —Ä–µ–∂–∏–º
npm start
```

–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É `http://localhost:3001`

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
backend/
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma     # –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ seed.js           # –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
‚îÇ   ‚îî‚îÄ‚îÄ dev.db            # SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config/           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ middleware/       # Middleware (auth, etc)
‚îÇ   ‚îú‚îÄ‚îÄ routes/           # API —Ä–æ—É—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ services/         # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ utils/            # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ index.js          # –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª
‚îú‚îÄ‚îÄ .env                  # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îî‚îÄ‚îÄ package.json
```

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **SQLite** —Å **Prisma ORM**.

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:
- `users` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- `halls` - –∑–∞–ª—ã —Å—Ç—É–¥–∏–∏
- `directions` - –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–Ω—Ü–µ–≤
- `trainers` - —Ç—Ä–µ–Ω–µ—Ä—ã
- `subscription_types` - —Ç–∏–ø—ã –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤
- `subscriptions` - –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `lessons` - —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π
- `bookings` - –∑–∞–ø–∏—Å–∏ –Ω–∞ –∑–∞–Ω—è—Ç–∏—è
- `rental_bookings` - –∞—Ä–µ–Ω–¥–∞ –∑–∞–ª–æ–≤/–ø–∏–ª–æ–Ω–æ–≤
- `notifications` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `settings` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã

### –ö–æ–º–∞–Ω–¥—ã Prisma

```bash
# –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
npx prisma migrate dev --name <–Ω–∞–∑–≤–∞–Ω–∏–µ>

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (production)
npx prisma migrate deploy

# –û—Ç–∫—Ä—ã—Ç—å Prisma Studio (GUI –¥–ª—è –ë–î)
npx prisma studio

# –û–±–Ω–æ–≤–∏—Ç—å Prisma Client –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã
npx prisma generate

# –ó–∞–ø–æ–ª–Ω–∏—Ç—å –±–∞–∑—É –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
npm run seed
```

## üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **Telegram Web App Authentication**:
1. Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `initData` –æ—Ç Telegram
2. Backend –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å—å —á–µ—Ä–µ–∑ Bot Token
3. –°–æ–∑–¥–∞–µ—Ç—Å—è/–Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ë–î
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è JWT —Ç–æ–∫–µ–Ω

## üì° API Endpoints

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- `POST /api/auth/login` - –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram
- `GET /api/auth/me` - –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ endpoints
- `GET /api/directions` - —Å–ø–∏—Å–æ–∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
- `GET /api/schedule` - —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π
- `POST /api/bookings` - –∑–∞–ø–∏—Å—å –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ
- `GET /api/bookings/my` - –º–æ–∏ –∑–∞–ø–∏—Å–∏
- `GET /api/subscription-types` - —Ç–∏–ø—ã –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤
- `POST /api/subscriptions` - –∫—É–ø–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç
- `GET /api/subscriptions/my` - –º–æ–∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã
- `GET /api/halls` - —Å–ø–∏—Å–æ–∫ –∑–∞–ª–æ–≤
- `POST /api/rental/bookings` - –∞—Ä–µ–Ω–¥–∞ –∑–∞–ª–∞/–ø–∏–ª–æ–Ω–∞
- `GET /api/profile` - –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `PUT /api/profile` - –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å

### –ê–¥–º–∏–Ω—Å–∫–∏–µ endpoints (—Ç—Ä–µ–±—É–µ—Ç—Å—è isAdmin=true)
- `GET /api/admin/bookings` - –≤—Å–µ –∑–∞–ø–∏—Å–∏
- `POST /api/admin/bookings` - —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å
- `PUT /api/admin/bookings/:id` - –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å
- `DELETE /api/admin/bookings/:id` - —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å
- `GET /api/admin/subscriptions` - –≤—Å–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã
- `PUT /api/admin/subscriptions/:id/confirm` - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç
- `GET /api/admin/lessons` - —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
- `POST /api/admin/lessons` - –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ
- `GET /api/admin/trainers` - —Ç—Ä–µ–Ω–µ—Ä—ã
- `POST /api/admin/trainers` - –¥–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–µ—Ä–∞
- `GET /api/admin/stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

## ü§ñ Telegram Bot

–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∑–∞–Ω—è—Ç–∏–∏ (–∑–∞ 4 —á–∞—Å–∞)
- –û—Ç–º–µ–Ω–∞ –∑–∞–Ω—è—Ç–∏—è
- –û–∫–æ–Ω—á–∞–Ω–∏–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ (–∑–∞ 3 –¥–Ω—è)

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞:
1. –°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather: `/newbot`
2. –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ `.env`
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Web App: `/newapp`

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ **Winston**.

–§–∞–π–ª—ã –ª–æ–≥–æ–≤:
- `logs/error.log` - —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
- `logs/combined.log` - –≤—Å–µ –ª–æ–≥–∏

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è Telegram Web App Data
- ‚úÖ JWT —Ç–æ–∫–µ–Ω—ã –¥–ª—è API
- ‚úÖ CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç SQL Injection (Prisma)
- ‚úÖ Rate limiting (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- ‚úÖ Helmet.js –¥–ª—è HTTP –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## üõ†Ô∏è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –ö–æ–º–∞–Ω–¥—ã npm

```bash
npm run dev      # –ó–∞–ø—É—Å–∫ –≤ dev —Ä–µ–∂–∏–º–µ (—Å nodemon)
npm start        # –ó–∞–ø—É—Å–∫ –≤ production —Ä–µ–∂–∏–º–µ
npm run seed     # –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ë–î –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–ø–∏—Å–∞–Ω—ã –≤ `.env.example`.

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

ISC


