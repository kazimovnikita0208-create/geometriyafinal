# Реализация автоматической записи для комбо-абонементов

## Описание

Реализована система выбора конкретных занятий для комбо-абонементов (8+4). Теперь пользователь может закрепить за собой конкретные занятия с указанием:
- Дня недели (1-7, где 1=Понедельник, 7=Воскресенье)
- Направления
- Времени начала и окончания
- Тренера (опционально)
- Зала (опционально)

## Пример использования

Для комбо-абонемента 8+4 можно выбрать:
1. **Вторник - Pole Fit в 20:00**
2. **Пятница - Растяжка в 19:00**
3. **Пятница - Pole Fit в 20:00**

## Структура данных

### Frontend (`formData.autoLessons`)
```typescript
autoLessons: Array<{
  day_of_week: number;      // 1-7 (1=Пн, 7=Вс)
  direction_id: number;
  start_time: string;       // "20:00"
  end_time: string;         // "21:00"
  trainer_id?: number;      // опционально
  hall_id?: number;         // опционально
}>
```

### Backend (поле `auto_lessons` в таблице `subscriptions`)
JSON массив с той же структурой.

## Изменения в коде

### 1. База данных
- Добавлено поле `auto_lessons TEXT` в таблицу `subscriptions`
- Миграция: `backend/scripts/addAutoLessonsField.js`

### 2. Frontend (`frontend/app/prices/page.tsx`)
- Добавлено поле `autoLessons` в состояние формы
- Для комбо-абонементов отображается форма выбора конкретных занятий
- Для обычных абонементов остаётся старый способ (направления + дни недели + время)
- Валидация проверяет, что для комбо-абонементов добавлено хотя бы одно занятие

### 3. Backend (`backend/src/routes/subscriptions.js`)
- Добавлена обработка `autoLessons` в запросе создания абонемента
- Валидация для комбо-абонементов проверяет каждое конкретное занятие
- Сохранение данных: для комбо используется `auto_lessons`, для обычных - старые поля

### 4. Автоматическая запись (`backend/src/routes/recurringLessons.js`)
- Обновлена логика автоматической записи:
  1. Сначала проверяются абонементы с конкретными занятиями (`auto_lessons IS NOT NULL`)
  2. Для каждого занятия проверяется соответствие:
     - День недели
     - Направление
     - Время (начало и окончание)
     - Тренер (если указан)
     - Зал (если указан)
  3. Затем проверяются абонементы со старым способом (для обратной совместимости)

## Как это работает

1. **При покупке комбо-абонемента:**
   - Пользователь выбирает "Автоматическая запись"
   - Отображается форма для добавления конкретных занятий
   - Пользователь добавляет занятия: день недели + направление + время
   - Данные сохраняются в поле `auto_lessons` как JSON

2. **При генерации расписания:**
   - Для каждого сгенерированного занятия проверяются все активные абонементы с `auto_lessons`
   - Если занятие соответствует критериям из `auto_lessons`, пользователь автоматически записывается
   - Проверяется наличие свободных мест и отсутствие дубликатов

## Обратная совместимость

Старый способ автоматической записи (направления + дни недели + время) продолжает работать для обычных абонементов. Для комбо-абонементов используется новый способ с конкретными занятиями.




